{% extends "SaaSInfoManagerCoreBundle:Default:base.html.twig" %}

{% block content %}

<div class="page-header row">

    <div class="col-lg-12 h3">
        <span class="glyphicon glyphicon-user"></span>
        <span>{{ 'Clients'|trans }}</span>
        <button class="btn btn-primary" id="add">{{ 'Add'|trans }}</button>
    </div>
</div>

<div class="col-lg-4">
    <div class="list-group">

        <input type="text" id="search" class="form-control" placeholder="{{ 'Search...'|trans }}" autocomplete="off" />
        <br />

{% if clientList|length > 0 %}
    {% for client in clientList %}

        <input type="hidden" class="search-index" value="{{ client.name|lower }} {{ client.email|lower }} {{ client.country.name }}" />

        <a href="{{ path('saas_info_manager_client_info', { 'id': client.id }) }}" class="list-group-item data-item load-via-ajax" data-target="saas_im_client_form">

            <span class="h4 list-group-item-heading">{{ client.name }}</span>
            <button type="button" class="close" aria-hidden="true" title="{{ 'Delete'|trans }}">&times;</button>
            <p class="list-group-item-text small">
                <span class="glyphicon glyphicon-phone-alt small"></span>
                <span>{{ client.contactNumber }}</span>
                <span class="glyphicon glyphicon-envelope small"></span>
                <span>{{ client.email }}</span>
                <br />
                <span class="glyphicon glyphicon-globe small"></span>
                <span>{{ client.country.name }}</span>
            </p>
        </a>

    {% endfor %}
        <a href="#" class="list-group-item list-group-item-info" id="noResultsNotice">
            <h4 class="list-group-item-heading">No matching results.</h4>
            <p class="list-group-item-text">Try a differnt search.</p>
        </a>

{% else %}
        <a href="#" class="list-group-item list-group-item-info">
            <h4 class="list-group-item-heading">No clients found.</h4>
            <p class="list-group-item-text">Click the "Add" button to add new clients.</p>
        </a>
{% endif %}
    </div>
</div>

<div class="col-lg-4">
{{ form_start(clientForm, { 'attr': { 'role': 'form', 'data-enitity_id': '', 'class': 'submit-via-ajax' } }) }}
{{ form_widget(clientForm._token) }}

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 id="clientName" class="panel-title">{{ form_widget(clientForm.name, { 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'Client Name'|trans } }) }}</h3>
        </div>
        <div class="panel-body">
            <div class="alert"></div>
            {{ form_row(clientForm.email, { 'label': 'Email'|trans, 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'General Email Address'|trans } }) }}
            {{ form_row(clientForm.contactNumber, { 'label': 'Contact Number'|trans, 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'General Contact Number'|trans } }) }}
            {{ form_row(clientForm.address1, { 'label': 'Address'|trans, 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'Address 1'|trans } }) }}
            {{ form_widget(clientForm.address2, { 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'Address 2'|trans } }) }}
            {{ form_widget(clientForm.city, { 'attr': { 'class': 'form-control editable editable-style', 'placeholder': 'City'|trans } }) }}
            {{ form_row(clientForm.countryCode, { 'label': 'Country'|trans, 'attr': { 'class': 'form-control editable editable-style' } }) }}
        </div>
        <div class="panel-footer text-right">
            <div class="">
            {{ form_row(clientForm.submit, { 'attr' : { 'class': 'btn btn-primary disabled' } }) }}
            </div>
        </div>
    </div>

{{ form_end(clientForm, { 'render_rest': false }) }}
</div>
<div class="col-lg-4">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 id="contacts" class="panel-title">{{ 'Contacts'|trans }}</h3>

        </div>
        <div class="panel-body">
            Panel content
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<style type="text/css">
    .editable-style {
        border-color: transparent;
        background-color: transparent;
        box-shadow: none;
    }

    .panel-title input {
        font-weight: bold;
        font-size: larger;
    }

    .alert-heading {
        padding-left: 4%;
    }
</style>
<script type="text/javascript">
    $(document).ready(function() {
        $('#noResultsNotice').hide();

        $('#search').on('keyup', function() {
            var key = $(this).val();

            $('.search-index').each(function() {
                if ($(this).val().toLowerCase().indexOf(key) === -1) {
                    $(this).next().hide();
                } else {
                    $(this).next().show();
                }
            });

            if ($('.data-item:visible').size() === 0) {
                $('#noResultsNotice').show();
            } else {
                $('#noResultsNotice').hide();
            }
        }).on('keydown', function(e) {

        });

        $('a.data-item').on('click', function() {
            highlight($(this));
        });

        $('.editable').on('mouseover', function() {
            $(this).removeClass('editable-style');
        }).on('mouseout', function() {
            $(this).addClass('editable-style');
        }).on('focus', function() {
            $(this).addClass('editable-style');
        }).on('blur', function() {
            $(this).addClass('editable-style');
        }).on('change', function() {
            $('button').removeClass('disabled');
        });

        $('.load-via-ajax').on('click', function(e) {
            e.preventDefault();
            var target = $(this).data('target');
            $.getJSON($(this).attr('href'), null, function(object) {
                $.each(object, function(property, value) {
                    $('#' + target + '_' + property).val(value);
                });
                $('#' + target).data('enitity_id', object.id);
            });
        });

    });

    $('#add').on('click', function() {
        $('#saas_im_client_form').trigger('reset');
        $('#saas_im_client_form').data('enitity_id', '');
        $('#saas_im_client_form input[type="text"]:first').trigger('focus');
    });

    $('.alert').hide();

    $('.submit-via-ajax').on('submit', function(e) {
        e.preventDefault();
        var data = $(this).serialize() + '&entityId=' + $(this).data('enitity_id');

        $.post($(this).attr('action'), data, function(object) {
            var container = $('#saas_im_client_form').find('.alert');
            var alertHeading, containerClass, iconClass;

            if (object.type === 'success') {
                alertHeading = '{{'Success'|trans}}';
                containerClass = 'alert-success';
                iconClass = 'glyphicon-ok';
            } else if (object.type === 'failure') {
                alertHeading = '{{'Failure'|trans}}';
                containerClass = 'alert-danger';
                iconClass = 'glyphicon-remove';
            }

            container
                    .html('')
                    .append($('<h4>').append($('<div>').addClass('glyphicon ' + iconClass)).append($('<span>').addClass('alert-heading').html(alertHeading)))
                    .append($('<p>').html(object.content))
                    .addClass(containerClass)
                    .fadeIn(400)
                    .delay(4800)
                    .fadeOut(1000)
                    ;
        }, 'json');
    });

    function highlight(obj) {
        obj.siblings('a').removeClass('active');
        obj.addClass('active');
    }
</script>
{% endblock %}
